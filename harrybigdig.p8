pico-8 cartridge // http://www.pico-8.com
version 27
__lua__
-- harry's big dig

-- globals
game = {}
game.width = 8
game.height = 100

world = {}
world.width = game.width*16
world.height = game.height*12

cam = {}
cam.x = 0
cam.y = -24

board = {}
clusters = {}
cluster_count = 1


-- board entries
-- each field is an int
-- mid bits:
-- 0 = empty
-- 1 = blue
-- 2 = yellow
-- 3 = red
-- 4 = pink
-- 
-- low bits:
-- for blocks:
-- 0 = no match to right or left
-- 1 = match on bottom
-- 2 = match to right
-- 3 = match to bottom and right
--
-- high bits:
-- cluster number
function init_board()
	for row=1,game.height,1 do
		row_vals = {}
		for col=1,game.width,1 do
		 value = shl(1+flr(rnd(4)),4)
		 add(row_vals,value)
		end
		add(board,row_vals)
	end
	--assign appearance
	for r=1,game.height,1 do
		for c=1,game.width,1 do
		 if r == game.height then
		 	if c < game.width then
		 		if board[r][c] == board[r][c+1] then
		 		 board[r][c] += 2
		 		 assign_clust_right(r,c)
		 		end
		 	end
		 elseif c == game.width then
		 	if board[r][c] == board[r+1][c] then
		 	 board[r][c] += 1
		 	 assign_clust_down(r,c)
		 	end
		 else
		  if band(board[r][c],0b11110000) == band(board[r][c+1],0b11110000) then
		   board[r][c] += 2
		   assign_clust_right(r,c)
		 	end
		  if band(board[r][c],0b11110000) == band(board[r+1][c],0b11110000) then
		   board[r][c] += 1
		   assign_clust_down(r,c)
		 	end
		 end
		 -- clustering
		 value=board[r][c]
		 myc = band(shr(value,8),0xfff)
		 if myc == 0 then
		 	board[r][c] += shl(cluster_count,8)
				add(clusters[cluster_count],{r,c})
			 cluster_count += 1	
		 end
		end
		
	end
end


function assign_clust_down(r,c)
 value=board[r][c]
 myc = band(shr(value,8),0xfff)
 otherval = board[r+1][c]
 otherc = band(shr(othervalue,8),0xfff)
 if myc == 0 then --new clust
 	if otherc == 0 then
 		board[r][c] += shl(cluster_count,8)
 		board[r+1][c] += shl(cluster_count,8)
 		clusters[cluster_count]={}
 		add(clusters[cluster_count],{r,c})
 		add(clusters[cluster_count],{r+1,c})
 		cluster_count += 1
 	else
 		board[r][c] += shl(otherc,8)
 		add(clusters[otherc],{r,c})
 	end
 else
 	if otherc == 0 then
	  board[r+1][c] += shl(myc,8)
	  add(clusters[myc],{r+1,c})  
	 else
	 	--merge clusters
	 end
 end
end


function assign_clust_right(r,c)
 value=board[r][c]
 myc = band(shr(value,8),0xfff)
 otherval = board[r][c+1]
 otherc = band(shr(othervalue,8),0xfff)
 if myc == 0 then 
 	if otherc == 0 then --new clust
	 	board[r][c] += shl(cluster_count,8)
	 	board[r][c+1] += shl(cluster_count,8)
	 	clusters[cluster_count]={}
	 	add(clusters[cluster_count],{r,c})
	 	add(clusters[cluster_count],{r,c+1})
	 	cluster_count += 1
	 else
	 	board[r][c] += shl(otherc,8)
 		add(clusters[otherc],{r,c})
	 end
 else
 	if otherc == 0 then
	  board[r][c+1] += shl(myc,8)
	  add(clusters[myc],{r,c+1})  
	 else
	 	-- merge clusters
	 end
 end
end


function board_get(x,y)
 return board[y+1][x+1]
end

function board_set(x,y,val)
	board[y+1][x+1] = val
end

function board_draw()
 starty = 12*(cam.y\12)
 for yy = starty,starty+132,12 do
  if (yy < 0) goto continue
  if (yy > world.height-1) goto continue
  ydraw=yy-cam.y
  yboard=yy\12
  for xx=0,127,16 do
  	xboard=xx\16
  	value = board_get(xboard,yboard)
  	hue=band(shr(value,4),0b1111)
  	shape=band(value,0b1111)
  	clust=band(shr(value,8),255)
  	ix = 1+32*(hue-1)+2*shape
  	spr(ix,xx,ydraw,2,1.5)
  	print(clust,xx+1,ydraw+1)
  	
  end
  ::continue::
 end
end

-- init and game loop
function _init()
	init_board()
	--stop()
end


function _update60()
	if (btn(2)) cam.y += -1
	if (btn(3)) cam.y += 1
end


function _draw()
	cls()
	board_draw()
	print(stat(0))
	print(stat(1))
	print(cluster_count)
end

-->8
--harry
-->8
--block
__gfx__
000000000cccccccccccccc10cccccccccccccc10ccccccccccccccc0ccccccccccccccc000000cccc0000000000000000000000000000000000000000000000
00000000ccccccccccccccc1ccccccccccccccc1cccccccccccccccccccccccccccccccc0000cccccccc00000000000000000000000000000000000000000000
00700700ccccccccccccccc1ccccccccccccccc1cccccccccccccccccccccccccccccccc000cccccccccc0000000000000000000000000000000000000000000
00077000ccccccccccccccc1ccccccccccccccc1cccccccccccccccccccccccccccccccc00ccc161161ccc000000000000000000000000000000000000000000
00077000cccccdddddccccc1cccccdddddccccc1cccccdddddcccccccccccdddddcccccc00cc11111111cc000000000000000000000000000000000000000000
00700700cccccdcccc6cccc1cccccdcccc6cccc1cccccdcccc6ccccccccccdcccc6ccccc00cc11111111cc000000000000000000000000000000000000000000
00000000cccccdcccc6cccc1cccccdcccc6cccc1cccccdcccc6ccccccccccdcccc6ccccc077c11111111c7700000000000000000000000000000000000000000
00000000cccccc66666cccc1cccccc66666cccc1cccccc66666ccccccccccc66666ccccc077cc616116cc7700000000000000000000000000000000000000000
00000000ccccccccccccccc1ccccccccccccccc1cccccccccccccccccccccccccccccccc000cccccccccc0000000000000000000000000000000000000000000
00000000ccccccccccccccc1ccccccccccccccc1cccccccccccccccccccccccccccccccc0000cccccccc00000000000000000000000000000000000000000000
00000000ccccccccccccccc1ccccccccccccccc1cccccccccccccccccccccccccccccccc000077cccc7700000000000000000000000000000000000000000000
000000001111111111111111ccccccccccccccc11111111111111111cccccccccccccccc00077700007770000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000aaaaaaaaaaaaaa10aaaaaaaaaaaaaa10aaaaaaaaaaaaaaa0aaaaaaaaaaaaaaa00000000000000000000000000000000000000000000000000000000
00000000aaaaaaaaaaaaaaa1aaaaaaaaaaaaaaa1aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa00000000000000000000000000000000000000000000000000000000
00000000aaaaaaaaaaaaaaa1aaaaaaaaaaaaaaa1aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa00000000000000000000000000000000000000000000000000000000
00000000aaaaaaaaaaaaaaa1aaaaaaaaaaaaaaa1aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa00000000000000000000000000000000000000000000000000000000
00000000aaaaa99999aaaaa1aaaaa99999aaaaa1aaaaa99999aaaaaaaaaaa99999aaaaaa00000000000000000000000000000000000000000000000000000000
00000000aaaaa9aaaafaaaa1aaaaa9aaaafaaaa1aaaaa9aaaafaaaaaaaaaa9aaaafaaaaa00000000000000000000000000000000000000000000000000000000
00000000aaaaa9aaaafaaaa1aaaaa9aaaafaaaa1aaaaa9aaaafaaaaaaaaaa9aaaafaaaaa00000000000000000000000000000000000000000000000000000000
00000000aaaaaafffffaaaa1aaaaaafffffaaaa1aaaaaafffffaaaaaaaaaaafffffaaaaa00000000000000000000000000000000000000000000000000000000
00000000aaaaaaaaaaaaaaa1aaaaaaaaaaaaaaa1aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa00000000000000000000000000000000000000000000000000000000
00000000aaaaaaaaaaaaaaa1aaaaaaaaaaaaaaa1aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa00000000000000000000000000000000000000000000000000000000
00000000aaaaaaaaaaaaaaa1aaaaaaaaaaaaaaa1aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa00000000000000000000000000000000000000000000000000000000
000000001111111111111111aaaaaaaaaaaaaaa11111111111111111aaaaaaaaaaaaaaaa00000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000088888888888888108888888888888810888888888888888088888888888888800000000000000000000000000000000000000000000000000000000
00000000888888888888888188888888888888818888888888888888888888888888888800000000000000000000000000000000000000000000000000000000
00000000888888888888888188888888888888818888888888888888888888888888888800000000000000000000000000000000000000000000000000000000
00000000888888888888888188888888888888818888888888888888888888888888888800000000000000000000000000000000000000000000000000000000
00000000888884444488888188888444448888818888844444888888888884444488888800000000000000000000000000000000000000000000000000000000
00000000888884888898888188888488889888818888848888988888888884888898888800000000000000000000000000000000000000000000000000000000
00000000888884888898888188888488889888818888848888988888888884888898888800000000000000000000000000000000000000000000000000000000
00000000888888999998888188888899999888818888889999988888888888999998888800000000000000000000000000000000000000000000000000000000
00000000888888888888888188888888888888818888888888888888888888888888888800000000000000000000000000000000000000000000000000000000
00000000888888888888888188888888888888818888888888888888888888888888888800000000000000000000000000000000000000000000000000000000
00000000888888888888888188888888888888818888888888888888888888888888888800000000000000000000000000000000000000000000000000000000
00000000111111111111111188888888888888811111111111111111888888888888888800000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000eeeeeeeeeeeeee10eeeeeeeeeeeeee10eeeeeeeeeeeeeee0eeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000
00000000eeeeeeeeeeeeeee1eeeeeeeeeeeeeee1eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000
00000000eeeeeeeeeeeeeee1eeeeeeeeeeeeeee1eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000
00000000eeeeeeeeeeeeeee1eeeeeeeeeeeeeee1eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000
00000000eeeeedddddeeeee1eeeeedddddeeeee1eeeeedddddeeeeeeeeeeedddddeeeeee00000000000000000000000000000000000000000000000000000000
00000000eeeeedeeeefeeee1eeeeedeeeefeeee1eeeeedeeeefeeeeeeeeeedeeeefeeeee00000000000000000000000000000000000000000000000000000000
00000000eeeeedeeeefeeee1eeeeedeeeefeeee1eeeeedeeeefeeeeeeeeeedeeeefeeeee00000000000000000000000000000000000000000000000000000000
00000000eeeeeefffffeeee1eeeeeefffffeeee1eeeeeefffffeeeeeeeeeeefffffeeeee00000000000000000000000000000000000000000000000000000000
00000000eeeeeeeeeeeeeee1eeeeeeeeeeeeeee1eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000
00000000eeeeeeeeeeeeeee1eeeeeeeeeeeeeee1eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000
00000000eeeeeeeeeeeeeee1eeeeeeeeeeeeeee1eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000
000000001111111111111111eeeeeeeeeeeeeee11111111111111111eeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000
